<!DOCTYPE html>
<html lang="ja">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splatoon3 æˆ¦ç¸¾è¨˜éŒ²</title>
  <script src="https://cdn.jsdelivr.net/gh/ysas4331/CustomSelect/CustomSelect.min.js"></script>
  <style>
   :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--chip-bg:rgba(255,255,255,.03);--chip-border:rgba(255,255,255,.06);--text:#e6eef6;--muted-2:#bfc9d2}*{box-sizing:border-box}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;margin:0;background:linear-gradient(180deg,#071022 0%,#071727 100%);color:var(--text);min-height:100vh;padding:28px}h1{margin:0 0 10px;font-size:20px}h2{font-size:18px;margin:0 0 16px;color:var(--text)}h3{font-size:15px;margin:20px 0 12px;color:var(--muted-2)}.container{max-width:1200px;margin:0 auto}.header{text-align:center;margin-bottom:24px}.header h1{font-size:28px;margin-bottom:6px}.header p{color:var(--muted);font-size:14px}.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}.tab{padding:10px 20px;border-radius:20px;background:var(--chip-bg);font-size:14px;cursor:pointer;border:1px solid var(--chip-border);color:var(--text);transition:all 0.15s}.tab:hover{transform:translateY(-2px)}.tab.active{background:linear-gradient(90deg,#0b5a6a,#064b56);color:#dff8ff;border-color:rgba(125,211,252,.18)}.card{background:var(--chip-bg);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,.03);box-shadow:0 6px 20px rgba(2,6,23,.6)}.tab-content{display:none}.tab-content.active{display:block}.form-group{margin-bottom:16px;position:relative}label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}input[type="text"],input[type="number"],select{background:transparent;border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:8px;color:var(--text);outline:none;width:100%;font-size:14px}input:focus,select:focus{border-color:var(--accent)}.autocomplete-container{position:relative}.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--accent);border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1000;display:none}.autocomplete-list.show{display:block}.autocomplete-item{padding:10px 12px;cursor:pointer;transition:background 0.15s;font-size:14px}.autocomplete-item:hover{background:var(--chip-bg)}.row{display:flex;gap:12px}.row .form-group{flex:1}.weapon-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px}button{background:var(--accent);border:none;padding:10px 16px;border-radius:8px;color:#042027;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.15s}button:hover{transform:translateY(-2px)}.btn-full{width:100%;margin-top:20px}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:20px}.stat-card{background:linear-gradient(180deg,rgba(125,211,252,.08),rgba(125,211,252,.03));padding:18px;border-radius:10px;text-align:center;border:1px solid rgba(125,211,252,.1)}.stat-card h3{font-size:13px;color:var(--muted);margin:0 0 8px 0}.stat-card .value{font-size:32px;font-weight:700;color:var(--accent)}.records-table{width:100%;border-collapse:collapse;margin-top:16px}.records-table th,.records-table td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}.records-table th{background:var(--chip-bg);font-weight:600;color:var(--muted-2)}.records-table tr:hover{background:var(--chip-bg)}.win{color:#22c55e;font-weight:600}.lose{color:#ef4444;font-weight:600}.btn-delete{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.04);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px}.btn-delete:hover{background:rgba(239,68,68,.1);border-color:#ef4444;color:#ef4444}.weapon-selector{margin-bottom:20px}.muted{color:var(--muted)}.scroll-container{max-height:60vh;overflow-y:auto;padding-right:6px}.select{position:relative;width:260px;background:var(--card);color:var(--text);padding:.6rem 1rem;border-radius:10px;cursor:pointer;user-select:none;margin:1rem 0}.select-dis{display:flex;justify-content:space-between;align-items:center}.select-arrow{transition:transform 0.25s}.open .select-arrow{transform:rotate(180deg)}.option{position:absolute;top:calc(100% + 5px);left:0;width:100%;background:var(--card);color:var(--text);border-radius:10px;padding:5px 0;box-shadow:0 6px 18px rgba(0,0,0,.35);display:none;z-index:20;max-height:200px;overflow-x:hidden;overflow-y:auto}.open .option{display:block}.option label{display:block;padding:.6rem 1rem;cursor:pointer}.option label:hover{background:rgba(125,211,252,.15)}.option label.active{background:rgba(125,211,252,.35)}.option .select-search{position:sticky;top:0;z-index:1;margin:0;width:100%;background:var(--card);color:var(--text);padding:.6rem 1rem;border-radius:10px;border:2px solid transparent;outline:none;user-select:none;transition:border-color 0.25s,box-shadow 0.25s}.option .select-search:not(.NoBorder):focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,211,252,.25)}.option .select-search::placeholder{color:var(--muted-2);opacity:.7}.option .select-search:disabled{background:var(--chip-bg);color:var(--muted);cursor:not-allowed}@media (max-width:768px){body{padding:16px}.header h1{font-size:22px}.weapon-grid{grid-template-columns:repeat(2,1fr)}.stats-grid{grid-template-columns:1fr}.records-table{font-size:12px}.records-table th,.records-table td{padding:8px}}
  </style>
  </head>
  <body>
  <div class="container">
  <div class="header">
  <h1>ğŸ¦‘ Splatoon3 æˆ¦ç¸¾è¨˜éŒ²</h1>
  <p class="muted">ãƒãƒˆãƒ«ã®è¨˜éŒ²ã‚’æ®‹ã—ã¦çµ±è¨ˆã‚’ç¢ºèªã—ã‚ˆã†ï¼</p>
  </div>
  
  <div class="tabs">
  <button class="tab active" onclick="switchTab('record', event)">ğŸ“ è¨˜éŒ²</button>
  <button class="tab" onclick="switchTab('stats', event)">ğŸ“Š çµ±è¨ˆ</button>
  <button class="tab" onclick="switchTab('history', event)">ğŸ“œ å±¥æ­´</button>
  </div>
  
  <!-- è¨˜éŒ²ã‚¿ãƒ– -->
  <div id="record" class="tab-content active">
  <div class="card">
  <h2>ãƒãƒˆãƒ«è¨˜éŒ²</h2>
  <form id="battleForm">
      <div class="form-group">
          <label>å‹æ•—</label>
          <div class="select" data-attr='"placeholder":false,"initial":0' id="result">
            <div class="option">
              <label>å‹åˆ©</label>
              <label>æ•—åŒ—</label>
            </div>
          </div>
      </div>
  
      <div class="row">
          <div class="form-group">
              <label>ã‚¹ãƒ†ãƒ¼ã‚¸</label>
              <div class="select" data-attr='"placeholder":false,"search":true,"initial":0' id="stage">
                <div class="option">
                </div>
              </div>
          </div>
  
          <div class="form-group">
              <label>ãƒ«ãƒ¼ãƒ«</label>
              <div class="select" data-attr='"placeholder":false,"initial":0' id="rule">
                <div class="option">
                  <label>ãƒŠãƒ¯ãƒãƒªãƒãƒˆãƒ«</label>
                  <label>ã‚¬ãƒã‚¨ãƒªã‚¢</label>
                  <label>ã‚¬ãƒãƒ¤ã‚°ãƒ©</label>
                  <label>ã‚¬ãƒãƒ›ã‚³ãƒãƒˆãƒ«</label>
                  <label>ã‚¬ãƒã‚¢ã‚µãƒª</label>
                </div>
              </div>
          </div>
      </div>
  
      <div class="form-group">
          <label>è‡ªåˆ†ã®æ­¦å™¨</label>
          <div class="select weapon" data-attr='"placeholder":false,"initial":0,"search":true' id="weapon">
            <div class="option">
            </div>
          </div>
      </div>
  
      <div class="row">
          <div class="form-group">
              <label>ã‚­ãƒ«æ•°</label>
              <input type="number" id="kills" min="0" required>
          </div>
  
          <div class="form-group">
              <label>ãƒ‡ã‚¹æ•°</label>
              <input type="number" id="deaths" min="0" required>
          </div>
  
          <div class="form-group">
              <label>å¡—ã‚Šãƒã‚¤ãƒ³ãƒˆ</label>
              <input type="number" id="paint" min="0" required>
          </div>
      </div>
  
      <h3>å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­¦å™¨</h3>
      <div class="weapon-grid">
          <div class="form-group">
              <div class="select weapon" data-attr='"placeholder":false,"initial":0,"search":true' id="weapon">
            <div class="option">
            </div>
          </div>
          </div>
          <div class="form-group">
              <label>å‘³æ–¹2</label>
              <input type="text" id="ally2" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
          <div class="form-group">
              <label>å‘³æ–¹3</label>
              <input type="text" id="ally3" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
          <div class="form-group">
              <label>æ•µ1</label>
              <input type="text" id="enemy1" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
          <div class="form-group">
              <label>æ•µ2</label>
              <input type="text" id="enemy2" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
          <div class="form-group">
              <label>æ•µ3</label>
              <input type="text" id="enemy3" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
          <div class="form-group">
              <label>æ•µ4</label>
              <input type="text" id="enemy4" class="weapon-input">
            <div class="autocomplete-list"></div>
          </div>
      </div>
  
      <button type="submit" class="btn-full">è¨˜éŒ²ã‚’ä¿å­˜</button>
  </form>
  </div>
  </div>
  
  <!-- çµ±è¨ˆã‚¿ãƒ– -->
  <div id="stats" class="tab-content">
  <div class="card">
  <h2>çµ±è¨ˆæƒ…å ±</h2>
  
  <div class="weapon-selector">
      <label>æ­¦å™¨ã‚’é¸æŠ</label>
      <select id="weaponFilter" onchange="updateStats()">
          <option value="all">å…¨ä½“</option>
      </select>
  </div>
  
  <div class="stats-grid" id="statsGrid"></div>
  </div>
  </div>
  
  <!-- å±¥æ­´ã‚¿ãƒ– -->
  <div id="history" class="tab-content">
  <div class="card">
  <h2>ãƒãƒˆãƒ«å±¥æ­´</h2>
  <div class="scroll-container">
      <table class="records-table">
          <thead>
              <tr>
                  <th>æ—¥æ™‚</th>
                  <th>å‹æ•—</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¸</th>
                  <th>ãƒ«ãƒ¼ãƒ«</th>
                  <th>æ­¦å™¨</th>
                  <th>K/D</th>
                  <th>å¡—ã‚ŠP</th>
                  <th>æ“ä½œ</th>
              </tr>
          </thead>
          <tbody id="historyBody"></tbody>
      </table>
  </div>
  </div>
  </div>
  </div>
  
  <script>
  let db;
  let stages = [];
  let weapons = [];
  
  let result = 'win';
  let rule = 'ãƒŠãƒ¯ãƒãƒªãƒãƒˆãƒ«';
  let stage = 'ãƒ¦ãƒãƒãƒŠå¤§æ¸“è°·';
  let weapon = 'ã‚¹ãƒ—ãƒ©ã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼';
  let allWeapons = {};
  cSelect.setup(document.querySelector('#result'));
  cSelect.setup(document.querySelector('#rule'));
  document.querySelector('#result').addEventListener('selectChanged', e => {
    result = e.detail.value==='å‹åˆ©'?'win':'lose';
  });
  document.querySelector('#rule').addEventListener('selectChanged', e => {
    rule = e.detail.value;
  });
  
  // IndexedDBåˆæœŸåŒ–
  function initDB() {
  const request = indexedDB.open('Splatoon3DB', 1);
  
  request.onerror = () => {
  console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼');
  };
  
  request.onsuccess = (e) => {
  db = e.target.result;
  loadHistory();
  updateWeaponFilter();
  updateStats();
  };
  
  request.onupgradeneeded = (e) => {
  db = e.target.result;
  if (!db.objectStoreNames.contains('battles')) {
      const objectStore = db.createObjectStore('battles', { keyPath: 'id', autoIncrement: true });
      objectStore.createIndex('timestamp', 'timestamp', { unique: false });
      objectStore.createIndex('weapon', 'weapon', { unique: false });
  }
  };
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—
  async function loadStages() {
  try {
  const response = await fetch('./datas.json');
  const data = await response.json();
  stages = data.stages || [];
  weapons = data.weapons || [];
  } catch (error) {
  console.error('ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
  stages = ['ãƒ¦ãƒãƒãƒŠå¤§æ¸“è°·', 'ã‚´ãƒ³ã‚ºã‚¤åœ°åŒº', 'ãƒ¤ã‚¬ãƒ©å¸‚å ´', 'ãƒãƒ†ã‚¬ã‚¤æ”¾æ°´è·¯', 'ãƒŠãƒ¡ãƒ­ã‚¦é‡‘å±'];
  }
  const stagelabels = stages.map(stage => `<label>${stage}</label>`).join('');
  document.querySelector('#stage > .option').innerHTML = stagelabels;
  cSelect.setup(document.querySelector('#stage'));
  document.querySelector('#stage').addEventListener('selectChanged', e => {
    stage = e.detail.value;
  });
  const weaponlabels = weapons.map(wp => `<label>${wp}</label>`).join('');
  document.querySelectorAll('.weapon').forEach(weapon => {
    weapon.querySelector('.option').innerHTML = weaponlabels;
    const searchInput = window.cSelect.setup(weapon);
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        let str = searchInput.value;
        str = str.replace(/[ã-ã‚“]/g, function(s) {
Â Â         return String.fromCharCode(s.charCodeAt(0) + 0x60);
        });
        searchInput.value = str;
      });
    }
  });
  document.querySelector('#weapon').addEventListener('selectChanged', e => {
    weapon = e.detail.value;
  });
  }
  
  function selectStage(stage) {
  stageInput.value = stage;
  stageList.classList.remove('show');
  }
  
  document.addEventListener('click', (e) => {
  if (!e.target.closest('.autocomplete-container')) {
  stageList.classList.remove('show');
  }
  });
  
  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  function switchTab(tabName, event) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
  
  if (tabName === 'history') {
  loadHistory();
  } else if (tabName === 'stats') {
  updateWeaponFilter();
  updateStats();
  }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  document.getElementById('battleForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const battle = {
  timestamp: new Date().toISOString(),
  result: result,
  stage: stage,
  rule: rule,
  weapon: weapon,
  kills: parseInt(document.getElementById('kills').value),
  deaths: parseInt(document.getElementById('deaths').value),
  paint: parseInt(document.getElementById('paint').value),
  allWeapons: allWeapons
  };
  
  const transaction = db.transaction(['battles'], 'readwrite');
  const objectStore = transaction.objectStore('battles');
  objectStore.add(battle);
  
  transaction.oncomplete = () => {
  alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
  e.target.reset();
  loadHistory();
  updateWeaponFilter();
  };
  });
  
  // å±¥æ­´èª­ã¿è¾¼ã¿
  function loadHistory() {
  const transaction = db.transaction(['battles'], 'readonly');
  const objectStore = transaction.objectStore('battles');
  const request = objectStore.getAll();
  
  request.onsuccess = () => {
  const battles = request.result.reverse();
  const tbody = document.getElementById('historyBody');
  
  tbody.innerHTML = battles.map(battle => `
      <tr>
          <td>${new Date(battle.timestamp).toLocaleString('ja-JP', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</td>
          <td class="${battle.result}">${battle.result === 'win' ? 'å‹ã¡' : 'è² ã‘'}</td>
          <td>${battle.stage}</td>
          <td>${battle.rule}</td>
          <td>${battle.weapon}</td>
          <td>${battle.kills}/${battle.deaths}</td>
          <td>${battle.paint}</td>
          <td><button class="btn-delete" onclick="deleteBattle(${battle.id})">å‰Šé™¤</button></td>
      </tr>
  `).join('');
  };
  }
  
  // æ­¦å™¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
  function updateWeaponFilter() {
  const transaction = db.transaction(['battles'], 'readonly');
  const objectStore = transaction.objectStore('battles');
  const request = objectStore.getAll();
  
  request.onsuccess = () => {
  const battles = request.result;
  const weapons = [...new Set(battles.map(b => b.weapon))];
  
  const select = document.getElementById('weaponFilter');
  select.innerHTML = '<option value="all">å…¨ä½“</option>' + 
      weapons.map(w => `<option value="${w}">${w}</option>`).join('');
  };
  }
  
  // çµ±è¨ˆæ›´æ–°
  function updateStats() {
  const weapon = document.getElementById('weaponFilter').value;
  const transaction = db.transaction(['battles'], 'readonly');
  const objectStore = transaction.objectStore('battles');
  const request = objectStore.getAll();
  
  request.onsuccess = () => {
  let battles = request.result;
  
  if (weapon !== 'all') {
      battles = battles.filter(b => b.weapon === weapon);
  }
  
  const totalBattles = battles.length;
  const wins = battles.filter(b => b.result === 'win').length;
  const losses = totalBattles - wins;
  const winRate = totalBattles > 0 ? ((wins / totalBattles) * 100).toFixed(1) : 0;
  const loseRate = totalBattles > 0 ? ((losses / totalBattles) * 100).toFixed(1) : 0;
  
  const totalKills = battles.reduce((sum, b) => sum + b.kills, 0);
  const totalDeaths = battles.reduce((sum, b) => sum + b.deaths, 0);
  const avgKills = totalBattles > 0 ? (totalKills / totalBattles).toFixed(2) : 0;
  const avgDeaths = totalBattles > 0 ? (totalDeaths / totalBattles).toFixed(2) : 0;
  const kdRatio = totalDeaths > 0 ? (totalKills / totalDeaths).toFixed(2) : totalKills;
  
  const totalPaint = battles.reduce((sum, b) => sum + b.paint, 0);
  const avgPaint = totalBattles > 0 ? Math.round(totalPaint / totalBattles) : 0;
  
  const statsGrid = document.getElementById('statsGrid');
  statsGrid.innerHTML = `
      <div class="stat-card">
          <h3>ç·ãƒãƒˆãƒ«æ•°</h3>
          <div class="value">${totalBattles}</div>
      </div>
      <div class="stat-card">
          <h3>å‹ç‡</h3>
          <div class="value">${winRate}%</div>
      </div>
      <div class="stat-card">
          <h3>æ•—ç‡</h3>
          <div class="value">${loseRate}%</div>
      </div>
      <div class="stat-card">
          <h3>å¹³å‡ã‚­ãƒ«æ•°</h3>
          <div class="value">${avgKills}</div>
      </div>
      <div class="stat-card">
          <h3>å¹³å‡ãƒ‡ã‚¹æ•°</h3>
          <div class="value">${avgDeaths}</div>
      </div>
      <div class="stat-card">
          <h3>K/Dæ¯”</h3>
          <div class="value">${kdRatio}</div>
      </div>
      <div class="stat-card">
          <h3>å¹³å‡å¡—ã‚Šãƒã‚¤ãƒ³ãƒˆ</h3>
          <div class="value">${avgPaint}</div>
      </div>
      <div class="stat-card">
          <h3>å‹åˆ© / æ•—åŒ—</h3>
          <div class="value">${wins} / ${losses}</div>
      </div>
  `;
  };
  }

    // å…±é€šã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½


function selectWeapon(w, id) {
  const input = document.getElementById(id);
  input.value = w;
  input.parentElement.querySelector('.autocomplete-list').classList.remove('show');
}

// å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', (e) => {
  if (!e.target.closest('.form-group')) {
    document.querySelectorAll('.autocomplete-list').forEach(box => {
      box.classList.remove('show');
    });
  }
});
  
  // å‰Šé™¤æ©Ÿèƒ½
  function deleteBattle(id) {
  if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  const transaction = db.transaction(['battles'], 'readwrite');
  const objectStore = transaction.objectStore('battles');
  objectStore.delete(id);
  
  transaction.oncomplete = () => {
  loadHistory();
  updateWeaponFilter();
  updateStats();
  };
  }
  
  // åˆæœŸåŒ–
  loadStages();
  initDB();
  </script>
  </body>
</html>
